(function(e,t,n){function l(t,n){this.element=t,this.options=e.extend({},s,n),this._defaults=s,this._plugin=r,this.init()}function c(t,n){var r=new u.kml.Manager;r.addObserver("state",e.proxy(function(e){e.state==="finished"&&n.call(this,e)},this)),r.parseKML(t)}function h(t){var n=t.target[t.type];if(e.isFunction(n)){var r=e.Event(t.type,{originalEvent:t,geo:{latitude:t.target.coordinate.latitude,longitude:t.target.coordinate.longitude},target:t.target});n.call(this.element,r)}}function p(e){return typeof e=="function"}var r="jOVI",i="0.2.0",s,o,u,a,f;s={appId:"_peU-uCkp-j8ovkzFGNU",authToken:"gBoUkAMoxoqIWfxWA5DuMQ",zoom:12,center:[52.49,13.37],enable:["behavior","zoombar","scalebar","typeselector"],behavior:!0,zoomBar:!0,scaleBar:!0,overview:!1,traffic:!1,publicTransport:!1,typeSelector:!0,positioning:!1,marker:{text:"",textColor:"#333333",fill:"#ff6347",stroke:"#333333",shape:"balloon",icon:undefined},bubble:{content:"",closable:!0,onclose:e.noop}},o=l.prototype,o.init=function(){var t=this.options;a.load().is.done(e.proxy(this.makemap,this))},o.makemap=function(){var t=this.options,n=u.map.component,i=[];n.Positioning=u.positioning.component.Positioning,f=f||{appId:t.appId,authenticationToken:t.authToken},u.util.ApplicationContext.set(f),e.data(this.element,r,!0),e.each(n,e.proxy(function(t,n){console.log(t),e.inArray(t.toLowerCase(),this.options.enable)>-1&&i.push(new n)},this)),this.map=new u.map.Display(this.element,{zoomLevel:t.zoom,center:t.center,components:i})},o.center=function(e){this.map.setCenter(e)},o.zoom=function(e){this.map.set("zoomLevel",e)},o.type=function(e){var t=this.map;switch(e){case"map":e=t.NORMAL;break;case"satellite":e=t.SATELLITE;break;case"terrain":e=t.TERRAIN;break;case"smart":e=t.SMARTMAP;break;default:e=t.NORMAL}t.set("baseMapType",e)},o.marker=function(t,n){var r={click:[e.proxy(h,this)||e.noop,!1,null],dblclick:[e.proxy(h,this)||e.noop,!1,null],mousemove:[e.proxy(h,this)||e.noop,!1,null],mouseover:[e.proxy(h,this)||e.noop,!1,null],mouseout:[e.proxy(h,this)||e.noop,!1,null],mouseenter:[e.proxy(h,this)||e.noop,!1,null],mouseleave:[e.proxy(h,this)||e.noop,!1,null],longpress:[e.proxy(h,this)||e.noop,!1,null],dragstart:[e.proxy(h,this)||e.noop,!1,null],drag:[e.proxy(h,this)||e.noop,!1,null],dragend:[e.proxy(h,this)||e.noop,!1,null]};n=e.extend({},s.marker,n),n.textPen=n.textPen||{strokeColor:n.textColor},n.pen=n.pen||{strokeColor:n.stroke},n.brush=n.brush||{color:n.fill},n.eventListener=r,n.icon?this.map.objects.add(new u.map.Marker(t,n)):this.map.objects.add(new u.map.StandardMarker(t,n))},o.bubble=function(t,n){var r;n=e.extend({},s.bubble,n),n.content.jquery&&(n.content.css("white-space","normal"),n.content=e("<div/>").append(n.content.clone()).html()),bubbles=this.map.getComponentById("InfoBubbles")||this.map.addComponent(new u.map.component.InfoBubbles),bubbles.openBubble(n.content,{latitude:t[0],longitude:t[1]},n.onclose,!n.closable)},o.kml=function(t,n,r){p(n)&&(r=n,n=!1),c.call(this,t,e.proxy(function(t){var i=new u.kml.component.KMLResultSet(t.kmlDocument,this.map);i.addObserver("state",e.proxy(function(e){var t,i;e.state=="finished"&&(n&&(t=e.container.objects.get(0),i=t.getBoundingBox(),i&&this.map.zoomTo(i)),p(r)&&r.call(this,e))},this)),this.map.objects.add(i.create())},this))},o.originalMap=function(e){e.call(this.element,this.map)},a={},a.is=!1,a.load=function(){var t,r,i;return a.is&&a.is.state()==="pending"?this:(a.is=e.Deferred(),i=function(){u=nokia.maps,u.Features.load({map:"auto",ui:"auto",search:"auto",routing:"auto",positioning:"auto",behavior:"auto",kml:"auto"},function(){a.is.resolve()})},t=n.getElementsByTagName("head")[0],r=n.createElement("script"),r.src="http://api.maps.nokia.com/2.2.1/jsl.js",r.type="text/javascript",r.charset="utf-8",r.onreadystatechange=function(){(r.readyState=="loaded"||r.readyState=="complete")&&i()},r.onload=i,t.appendChild(r),this)},e.fn[r]=function(t){var n=arguments;return this.each(function(){var i,s,o="plugin_"+r;i=e.data(this,o),i?(typeof t!="string"&&e.error(r+"::Plugin already initialized on this element, expected method."),s=t,n=Array.prototype.slice.call(n,1),typeof i[s]!="function"&&e.error(r+"::Method "+s+" does not exist"),a.load().is.done(function(){i[s].apply(i,n)})):(i=new l(this,t),e.data(this,o,i))})}})(jQuery,window,document);